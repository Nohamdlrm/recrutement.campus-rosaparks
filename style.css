const DB_URL = "https://campus-rosa-parks-default-rtdb.europe-west1.firebasedatabase.app/candidatures.json";
const ADMIN_MAIL = "ce.0227235a@campus-rosaparks.fr";

// VERIF ADMIN
function checkAdmin(response) {
    const user = JSON.parse(atob(response.credential.split('.')[1]));
    if(user.email === ADMIN_MAIL) {
        document.getElementById('admin-view').style.display = 'block';
        document.getElementById('admin-logged').style.display = 'block';
        document.getElementById('login-container').style.display = 'none';
        fetchCandidates();
    } else {
        alert("Accès Refusé : Vous n'êtes pas administrateur !");
    }
}

// NAVIGATION
function openApp(role) {
    document.getElementById('role-selection').style.display = 'none';
    document.getElementById('form-view').style.display = 'block';
    document.getElementById('role-val').value = role;
    document.getElementById('eng-text').innerText = (role === 'prof') 
        ? "Je m'engage à remplir Pronote avant 21h et à ne pas démissionner sans prévenir."
        : "Je m'engage à assurer mes surveillances et respecter le règlement.";
}

function goBack() {
    document.getElementById('form-view').style.display = 'none';
    document.getElementById('role-selection').style.display = 'block';
}

// ENVOI FIREBASE
document.getElementById('applyForm').onsubmit = async function(e) {
    e.preventDefault();
    const data = {
        nom: document.getElementById('nom').value,
        discord: document.getElementById('discord').value,
        matiere: document.getElementById('matiere').value,
        motiv: document.getElementById('motiv').value,
        role: document.getElementById('role-val').value,
        date: new Date().toLocaleString()
    };

    await fetch(DB_URL, { method: 'POST', body: JSON.stringify(data) });
    document.getElementById('pop-success').style.display = 'flex';
};

// FETCH ADMIN
async function fetchCandidates() {
    const res = await fetch(DB_URL);
    const data = await res.json();
    const list = document.getElementById('candidates-list');
    list.innerHTML = "";

    if(!data) { list.innerHTML = "Aucun dossier."; return; }

    Object.entries(data).reverse().forEach(([id, c]) => {
        list.innerHTML += `
            <div class="candidature-item">
                <button onclick="deleteCandid('${id}')" style="position:absolute; right:15px; top:15px; background:red; color:white; border:none; padding:5px; border-radius:5px; cursor:pointer;">Supprimer</button>
                <span style="color:var(--accent); font-weight:bold;">${c.role.toUpperCase()}</span><br>
                <h3>${c.nom}</h3>
                <p>Discord: ${c.discord} | Pôle: ${c.matiere}</p>
                <p style="font-style:italic;">"${c.motiv}"</p>
                <small>Posté le : ${c.date}</small>
            </div>
        `;
    });
}

// SUPPRESSION
async function deleteCandid(id) {
    if(confirm("Supprimer ce dossier définitivement ?")) {
        await fetch(`https://campus-rosa-parks-default-rtdb.europe-west1.firebasedatabase.app/candidatures/${id}.json`, { method: 'DELETE' });
        fetchCandidates();
    }
}
